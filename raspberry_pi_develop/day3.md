# 라즈베리파이 vscode-server 개발기 #3

## 0. 개요
code-server가 같은 wifi 상에서 정상적으로 연결되는 것은 확인했고, 이제 외부에서 접속할 수 있도록 한다.

## 1. wifi ip 고정

가정용 와이파이 공유기는 자동으로 ip를 할당해주는 유동 ip를 사용하는 경우가 많기 때문에 안정성을 위해서 고정 ip를 할당한 이후에 포트포워딩을 진행한다.

> 대상 파일
```py
cd /etc/netplan
sudo vi "버전별로 파일명 다름"
#리눅스 20.04 기준으로, 50-cloud-init.yaml
```
 
 혹시 모를 상황을 대비해서, 참고한 블로그에서 했던 것처럼 백업을 해놓고 진행하려 한다.

 > 백업
 ```py
 # 복사
sudo cp 50-cloud-init.yaml "새로운 파일명".yaml
# 파일명 변경
sudo mv 50-cloud-init.yaml 50-cloud-init.yaml_backup
 ```

 파일을 수정하기에 앞서, ifconfig(안되면 net tools 설치하면 됨)로 ip 주소를 확인해보면 현재 할당되어 있는 ip는 `172.30.1.34`이다.

 파일 내부를 다음과 같이 수정하면 된다.

 ![image](https://user-images.githubusercontent.com/68508521/205297794-8efa8c25-6fe7-4ca2-ae11-625a886b7e95.png)

eth0는 보통 유선 인터넷이고, wlan0가 라즈베리파이의 와이파이 모듈이므로 이 아래만 수정해도 무방하다.  

- addresses : 내가 설정할 ip 주소. 잘은 모르지만 원래 할당받은 ip 주소의 맨 끝부분 (X.X.X.000)만 수정해야할 것 같다. 사실 안해봐서 모른다. 난 대충 쫄려서 바뀐지 확인만 하려고 할당받은 주소에서 +-1만 고쳤다. 뒤에 붙은 /24는 구글에 찾아보면 나오지만 한귀로 흘려듣고 일단 남들이 붙이길래 나도 붙였다.
- gateway4 : 내 공유기의 기본 게이트웨이. default gateway로 인터넷에 찾으면 나온다. cmd에서 ipconfig해도 나온다. 맥에선 모름.
- nameserver-addresses : 노트북을 그 와이파이에 연결한 다음에 거기 네트워크 설정 잘 뒤져서 IPv4 DNS서버 시적과 끝 적어주면 된다. KT는 다 내 경우와 동일하니 복붙해도 된다. 
- 그 외: 아래에 dhcp4, optional은 둘 다 주석처리하면 된다.  

### 주의할 점
yaml 파일은 indent에 아주아주 예민하므로, 함부로 tab하면 안된다. 가급적 똑같이 따라할 것. tab하나만 잘못해도 뒤집어지는게 yaml이라서... 

> 변경 적용
```py
sudo netplan generate
sudo netplan apply
```
이거 누르는 순간 wifi로 접속하고 있었던 경우는 바로 튕긴다. 당연히 기존에 접속하던 ip에서 바뀌어서이다. 당황하지말고 내가 아까 바꾼 ip로 다시 ssh 연결하면 된다. 까먹었으면 강제로 유선연결 해야함. 

이제 다시 접속해서 ifconfig 해보면 달라진 내 ip의 모습을 확인할 수 있다!

## 2. 포트포워딩

포트포워딩은 외부 공인 ip(식별 가능, 유일함)를 통해서, 우리집의 공유기가 만든 자체 ip(식별 불가, 유일하지 않음)에 연결된 기기에 접속할 수 있도록 하는 방법이다. 인터넷에 잘 나와있으므로 자세한 방법은 패스!  

내부 ip 주소 = 라즈베리파이가 집 공유기로부터 할당받는 내부 ip, 즉 위에서 고정시킨 ip. 헷갈리면 ifconfig치고 wlan0에 뜨는 ip 넣으면 된다.  

외부 포트 = 아무거나 원하는 포트  

내부 포트 = 아까 ssh 접속을 위해 정해놨던 포트(이전글 기준 1234, 5678)  

그럼 이제 언제 어디서나 다음 코드로 라즈베리파이에 접속할 수 있다. 

> 포트포워딩 이후 라즈베리파이 접속
```py
ssh "ID"@"public IP" -p "설정한 포트"

# id=ABC, 공인 ip=0.0.0.0, 외부포트=1234이면
ssh ABC@0.0.0.0 -p 1234

#단, 이때는 라즈베리파이에서 ssh를 허용한 포트와 외부 포트를 맞춰줘야 한다.
```

하지만 code-server 접속을 위해서, code-server 연결을 위한 포트로 포트포워딩을 다시 해줘야 한다. 이전 글에서, code-server/config.yaml 파일에서 우리는 비밀번호를 설정하고 "원하는 포트"를 설정했다. 이 포트는 외부에서 접속하는게 불가하다. 그야 포트포워딩을 안했으니까! 따라서 위에 했던거랑 똑같이 하되  

외부 포트 = 아무거나 원하는 포트(ex 9876)

내부 포트 = 아까 code-server 접속을 위해 정해놨던 포트  

만 지켜주면 된다. 난 매번 외부, 내부 다르게 하면 헷갈릴 것 같아서 그냥 외부=내부포트로 통일했다.

<br>

> 포트포워딩 이후 code-server 접속
```py
공인 ip:(위에서 정한 포트, ex 9876)
```

이제 인터넷이 지원되는 모든 기기에서, 이를 입력하면 언제 어디서든 vscode-server에 접속해서 자유자재로 코딩을 할 수 있다! 하지만 아직 보안연결이 안된다는게 함정.. 보안 관련은 다음 글에서!

## Reference
- ip 고정 : https://powernote.tistory.com/11
- 포트포워딩 : https://fishcoding.tistory.com/62x